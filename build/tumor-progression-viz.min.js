/*! tumor-progression-viz 2015-02-20 */
function parseStage(a){if(!a)return 0;try{var b=+a;if("NaN"!==b)return b}catch(c){}return a=a.toLowerCase(),_.startsWith(a,"iv")?4:_.startsWith(a,"iii")?3:_.startsWith(a,"ii")?2:_.startsWith(a,"i")?1:void 0}function initChart(){function a(a){var b=Math.floor(a/30);return b}function b(b){var d=["Cancer Staging","Ecog Score","Karnofsky"],e=0,h=1e7,i={};$.each(d,function(){i[this]={},i[this].data=[],i[this].maxDataPoint=0});var j=d3.scale.category10();b.forEach(function(b){if(g[b.PATIENT_ID]||(g[b.PATIENT_ID]=[]),b.time=a(+b.TIME),b.time>e&&(e=b.time),b.time<h&&(h=b.time),"CA_STG_STAGE"===b.DISEASE_TYPE){b.type="Cancer Staging";var c=_.words(b.VALUE,/[^,\]\[ ]+/g);if(c.length>1){b.raw_value=parseStage(c[0]);for(var d=1;d<c.length;d++){var f=_.clone(b);f.raw_value=parseStage(c[0]),f.raw_value>i[b.type].maxDataPoint&&(i[b.type].maxDataPoint=f.raw_value),$.isNumeric(f.raw_value)&&i[b.type].data.push(f)}}else b.raw_value=parseStage(c[0])}else"K_OR_ECOG_SCORE"===b.DISEASE_TYPE&&(_.startsWith(b.VALUE,"KPS")?(b.type="Karnofsky",b.raw_value=+b.VALUE.substring(4,b.VALUE.length)):(b.type="Ecog Score",b.raw_value=+b.VALUE.substring(5,b.VALUE.length)));b.raw_value>i[b.type].maxDataPoint&&(i[b.type].maxDataPoint=b.raw_value),$.isNumeric(b.raw_value)&&(g[b.PATIENT_ID].push(b),i[b.type].data.push(b))});var k=0;$.each(i,function(a,b){f.push(new c(a,b.data,k++===d.length-1,h,e,b.maxDataPoint,j(a)))})}function c(a,b,c,f,g,h,i){var j=c?40:8,k={top:10,right:20,bottom:j,left:100},l=$("#chart").width()-k.left-k.right,m=200-k.top-k.bottom,n=d3.scale.linear().range([0,l]),o=d3.scale.linear().range([m,0]),p=d3.svg.axis().tickFormat(d3.format("d")).scale(n).orient("bottom"),q=d3.svg.axis().tickFormat(d3.format("d")).scale(o).orient("left"),r=d3.select("#chart").append("svg").attr("width",l+k.left+k.right).attr("height",m+k.top+k.bottom).append("g").attr("transform","translate("+k.left+","+k.top+")");$("#scaleright").val(g),n.domain([f,g]).nice(),o.domain([0,h]).nice(),this.bottomAxis=void 0,c&&(this.bottomAxis=r.append("g").attr("class","x axis").attr("transform","translate(0,"+m+")").style("fill","lightgray").call(p)),r.append("g").attr("class","y axis").style("fill","lightgray").call(q).append("text").attr("class","label").attr("transform","rotate(-90)").attr("y",2).attr("dy",".71em").style("text-anchor","end").text(a),r.selectAll(".dot").data(b).enter().append("circle").attr("class","dot").attr("color",i).attr("patient_id",function(a){return a.PATIENT_ID}).attr("r",5).attr("fhx",function(a){return d[+a.PATIENT_ID]?"hasfx":"none"}).attr("cx",function(a){return n(a.time)}).attr("cy",function(a){return o(a.raw_value)}).style("opacity",e).style("cursor","pointer").style("fill",function(){return i}).on("click",function(){var a=$(this).attr("patient_id"),b=d[+a];b?($("#family-history").css("opacity","1"),$("#family-history-detail").text(b)):($("#family-history-detail").css("opacity","0"),$("#family-history-detail").text("None found.")),$("#patient").css("opacity","1"),$("#patient-detail").text("#"+a),d3.selectAll("circle:not([patient_id='"+a+"'])").style("fill","white").style("opacity",.009).style("z-index","1"),setTimeout(function(){d3.selectAll("[patient_id='"+a+"']").style("z-index","90000").style("fill",function(){return $(this).attr("color")}).style("opacity",1)},300)}),this.svg=r,this.xScale=n,this.yScale=o}var d={},e="0.6",f=[],g={};d3.csv("data/history.csv",function(a){$.each(a,function(){"PATIENT"!==this.VALUE&&("YES"===this.VALUE&&(this.VALUE=""),d[+this.PATIENT_ID]=this.VALUE)}),console.log(d)}),setTimeout(function(){d3.csv("data/data.csv",b)},650),$("body").click(function(a){if("circle"!==a.target.nodeName){setTimeout(function(){d3.selectAll("circle").style("opacity",e).style("fill",function(){return $(this).attr("color")})},300);{$(this).attr("patient_id")}$("#patient").css("opacity","0.1"),$("#patient-detail").text(""),$("#family-history-detail").text(""),$("#family-history-detail").css("opacity","1"),$("#family-history").css("opacity","0.1")}}),$("#family-history").on("mouseover",function(){$("circle[fhx='hasfx']").css("opacity","1").css("fill",function(){return $(this).attr("color")}).css("z-index","99999"),$("circle[fhx='none']").css("opacity",0).css("z-index","1"),$("#family-history").css("opacity","1")}).on("mouseout",function(){$("#patient").css("opacity","0.1"),$("circle").css("fill",function(){return $(this).attr("color")}),$("#family-history-detail").text(""),$("#family-history-detail").css("opacity","1"),$("#family-history").css("opacity","0.1"),$("circle").css("opacity",e)})}$(document).ready(function(){initChart()});