/*! tumor-progression-viz 2015-02-25 */
function parseNumeric(a){try{return+a.trim()}catch(b){console.log("unable to parse "+a)}return-1}function getRandomInt(a,b){return Math.floor(Math.random()*(b-a))+a}function initChart(){function a(a){var b=Math.floor(a/timeIncrements);return b}function b(b){var d=0,e=1e7,i={},j=d3.scale.category10();b.forEach(function(b){var c=!1;g[b.SUBJECT_ID]||(g[b.SUBJECT_ID]=[]),$.inArray(b.TYPE,h)<0&&(h.push(b.TYPE),i[b.TYPE]={},i[b.TYPE].data=[],i[b.TYPE].maxDataPoint=0),b.time=a(+b.TIME),b.time>d&&(d=b.time),b.time<e&&(e=b.time),b.type=b.TYPE,b.transition=getRandomInt(100,maxLongTransition)+"",b.fast_transition=getRandomInt(25,maxShortTransition)+"",b.raw_value=+b.VALUE,$.isNumeric(b.raw_value)||(c=!0),c||(b.raw_value>i[b.type].maxDataPoint&&(i[b.type].maxDataPoint=b.raw_value),g[b.SUBJECT_ID].push(b),i[b.type].data.push(b))});var k=0;$.each(i,function(a,b){f.push((new c).renderChart(a,b.data,k++===h.length-1,e,d,b.maxDataPoint,j(a),!0))})}function c(){function a(a,b,c){var d=[];return maxN=+b,minN=+a,$.each(c,function(){this.time>=minN&&this.time<=maxN&&d.push(this)}),d}var b=this;this.renderChart=function(a,c,g,h,i,j,k,l){this.label=a,l&&(this.data=c),this.showBottonLegend=g,this.minXAxisVal=h,this.maxXAxisVal=i,this.maxYAxisVal=j,this.color=k;var m=g?40:8,n={top:10,right:20,bottom:m,left:100},o=$("#chart").width()-n.left-n.right,p=200-n.top-n.bottom;this.width=o,this.height=p;var q=d3.scale.linear().range([0,o]),r=d3.scale.linear().range([p,0]),s=d3.svg.axis().tickFormat(d3.format("d")).scale(q).orient("bottom"),t=d3.svg.axis().tickFormat(d3.format("d")).scale(r).orient("left"),u=d3.select("#chart").append("svg").attr("width",o+n.left+n.right).attr("height",p+n.top+n.bottom).append("g").attr("transform","translate("+n.left+","+n.top+")");$("#scaleright").val(i),q.domain([0,i]).nice(),r.domain([0,j]).nice(),$("#scale-left").val(h),$("#scale-right").val(i),this.bottomAxis=void 0,g&&(this.bottomAxis=u.append("g").attr("class","x axis").attr("transform","translate(0,"+p+")").style("fill","lightgray").call(s)),u.append("g").attr("class","y axis").style("fill","lightgray").call(t).append("text").attr("class","label").attr("y",2).attr("x",function(){return q(i)-10}).attr("dy",".71em").style("text-anchor","end").style("font-size","12px").text(a);var v=d3.tip().attr("class","d3-tip s").html(function(b){var c=showSubjectId?subjectLabel+":<br/><span class='tip-info'>"+b.SUBJECT_ID+"</span><br/><br/>":"";return $.each(d,function(){e[this].struct[b.SUBJECT_ID]&&(c+="Filters:",$.each(e[this].struct[b.SUBJECT_ID],function(){c+="<br/><span class='tip-info'> "+this.split("_").join(" ")+"</span>"}))}),c+="<br/><br/>"+a+":",c+="<br/><span class='tip-info'> "+b.raw_value+"<span class='tip-sub-info'> (at "+timeUnit+" "+b.time+"</span>)</span>"});return u.call(v),u.selectAll(".dot").data(c).enter().append("circle").attr("class","dot").attr("color",k).attr("subject_id",function(a){return a.SUBJECT_ID}).attr("r",5).attr("cx",function(a){return q(a.time)}).attr("cy",function(a){return r(a.raw_value)}).style("opacity",0).style("cursor","pointer").style("fill",function(){return k}).on("click",function(){var a=$(this).attr("subject_id");$.each(f,function(){this.showClickLine(a)}),$(".filter").css("opacity","0.1"),$.each(d,function(){var b=this,c=e[this].struct[a];$(".filter-detail[key='"+b+"'").empty(),c&&$.each(c,function(a,c){$(".filter[key='"+b+"'").css("opacity","1"),$(".filter-detail[key='"+b+"'").append(c+"<br/>")})}),$("#subject").css("opacity","1"),$("#subject-detail").text(a),d3.selectAll(".line[subject_id='"+a+"']").style("opacity","1"),d3.selectAll("circle:not([subject_id='"+a+"'])").transition().duration(function(a){return a.fast_transition}).ease("bounce").style("fill","white").style("opacity",.009).style("z-index","1"),setTimeout(function(){d3.selectAll("[subject_id='"+a+"']").transition().duration(function(a){return a.fast_transition}).ease("bounce").style("z-index","90000").style("fill",function(){return $(this).attr("color")}).style("opacity",1)},100)}).on("mouseover",v.show).on("mouseout",v.hide),d3.selectAll(".dot").transition().duration(function(a){return a.transition}).ease("bounce").style("opacity",opac),this.svg=u,this.xScale=q,this.yScale=r,this.xAxis=s,this.yAxis=t,$.each(d,function(){var a=this,b=e[a].structInverse;$.each(b,function(){var b=this,c=a.split(" ").join("_").toLowerCase();u.selectAll("circle.dot").attr(c,function(a){return $.inArray(a.SUBJECT_ID,b)>=0?"true":"false"})})}),b},this.showClickLine=function(a){var c=d3.svg.line().x(function(a){return b.xScale(a.time)}).y(function(a){return b.yScale(a.raw_value)}),d=[];$.each(g[a],function(){console.log(this),this.TYPE===b.label&&d.push(this)}),this.svg.append("path").datum(d).attr("class","line click-line").attr("d",c).attr("stroke",this.color)},this.updateChart=function(c,d){var e=a(c,d,this.data);return b.renderChart(b.label,e,b.showBottonLegend,+c,+d,b.maxYAxisVal,b.color,!1),b}}var d=[],e={},f=[],g={},h=[];d3.csv("data/static.csv",function(a){$.each(a,function(){e[this.TYPE]||(e[this.TYPE]={},e[this.TYPE].struct={},e[this.TYPE].structInverse={},d.push(this.TYPE)),e[this.TYPE].struct[this.SUBJECT_ID]||(e[this.TYPE].struct[this.SUBJECT_ID]=[]),e[this.TYPE].structInverse[this.VALUE]||(e[this.TYPE].structInverse[this.VALUE]=[]),e[this.TYPE].struct[this.SUBJECT_ID].push(this.VALUE),e[this.TYPE].structInverse[this.VALUE].push(this.SUBJECT_ID)}),$.each(d,function(){$("<div><h3 class='filter' style='opacity:0.1' key='"+this+"'>"+this.split("_").join(" ")+"</h3><p class='filter-detail' key='"+this+"'/></div>").appendTo($("#right-filters"))}),$(".filter").click(function(a){filterCircles($(this),a)})}),setTimeout(function(){d3.csv("data/data.csv",b)},100),$("body").click(function(a){"circle"!==a.target.nodeName&&reset()}),$("#reset-scale").click(function(){$("#chart").empty(),$.each(f,function(){this.updateChart($("#scale-left").val(),$("#scale-right").val())})}),$(".scale-box").keypress(function(a){13===a.which&&$("#reset-scale").trigger("click")})}function reset(){setTimeout(function(){d3.selectAll("circle").transition().duration(function(a){return a.fast_transition}).style("opacity",opac).style("fill",function(){return $(this).attr("color")})},100),$("#patient").css("opacity","0.1"),$("#patient-detail").text(""),$(".click-line").detach(),$(".filter-detail").text("").css("opacity","1"),$(".filter").css("opacity","0.1")}function filterCircles(a,b){var c=a.attr("key").toLowerCase();if("1"===a.css("opacity"))reset();else{var d="circle["+c+"='true']";offSelector="circle["+c+"='false']",$(".filter[key!='"+c+"']").css("opacity","0.1"),d3.selectAll(d).transition().duration(function(a){return a.fast_transition}).ease("bounce").style("opacity","1").style("fill",function(){return $(this).attr("color")}).style("z-index","99999"),d3.selectAll(offSelector).transition().duration(function(a){return a.fast_transition}).style("bounce").style("fill","white").style("opacity",.009).style("z-index","1"),a.css("opacity","1")}b.stopPropagation()}var timeIncrements=1,showSubjectId=!0,chartLabel="Hospital Acquired Infections",chartFor="Overall Standardized Infection Ratio",maxLongTransition=3e3,maxShortTransition=900,subjectLabel="Hospital",timeUnit="year",summary="Data begins in 2008. Source data can be found <a href='https://catalog.data.gov/dataset/hospital-acquired-infections-beginning-2008'>here</a>.",opac="0.6";$(document).ready(function(){initChart(),showSubjectId||$("#patient-filter").hide(),$("#day-increments").text(timeIncrements),$("#chart-label").text(chartLabel),$("#chart-for").text(chartFor),$("#summary").html(summary),$("#subject").text(subjectLabel),$(".time-unit").text(_.startCase(timeUnit))});